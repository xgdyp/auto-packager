# .github/workflows/comment-triggered-build.yml

name: Comment Triggered Docker Build

# è§¦å‘æ¡ä»¶ï¼šå½“åœ¨Issueæˆ–Pull Requestä¸­åˆ›å»ºæ–°è¯„è®ºæ—¶
on:
  issue_comment:
    types: [created,edit]
  issues:
    types: [opened, edited,labeled]

jobs:
  build-and-push:
    # å®‰å…¨æªæ–½ï¼š
    # 1. ç¡®ä¿è¯„è®ºå†…å®¹åŒ…å« "/build" æŒ‡ä»¤
    # 2. ç¡®ä¿è¯„è®ºè€…æ˜¯ä»“åº“çš„æ‰€æœ‰è€…(OWNER)ã€æˆå‘˜(MEMBER)æˆ–åä½œè€…(COLLABORATOR)ï¼Œé˜²æ­¢ä»»æ„ç”¨æˆ·è§¦å‘æ„å»º
    if: |
      contains(github.event.comment.body, '/build') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read      # è¯»å–ä»“åº“å†…å®¹
      packages: write    # å†™å…¥ GHCR
      issues: write      # å›å¤è¯„è®º

    steps:
      - name: ğŸ’¬ 1. è§£æè¯„è®ºå†…å®¹
        id: parse_comment
        run: |
          # ä»è¯„è®ºä¸­æå– git ä»“åº“åœ°å€
          # ä¾‹å¦‚: /build https://github.com/user/repo.git
          REPO_URL=$(echo "${{ github.event.comment.body }}" | grep -o 'https://github.com/[^ ]*' | head -n 1)
          if [ -z "$REPO_URL" ]; then
            echo "é”™è¯¯ï¼šåœ¨è¯„è®ºä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„ GitHub ä»“åº“åœ°å€ã€‚"
            exit 1
          fi
          # ä»URLä¸­æå–ä»“åº“åï¼Œä¾‹å¦‚ "user/repo"
          REPO_NAME=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's/\.git$//')
          
          echo "target_repo_url=${REPO_URL}" >> $GITHUB_OUTPUT
          echo "target_repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "target_repo_url=${REPO_URL}"
          echo "target_repo_name=${REPO_NAME}" 
          echo "é•œåƒåç§°å°†æ˜¯ï¼š ghcr.io/${{ github.repository_owner }}/${REPO_NAME##*/}"

      - name: ğŸ—£ï¸ 2. å›å¤è¯„è®ºï¼Œå‘ŠçŸ¥ä»»åŠ¡å·²å¼€å§‹
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ æ”¶åˆ°æ„å»ºè¯·æ±‚ï¼\n* **ç›®æ ‡ä»“åº“:** \`${{ steps.parse_comment.outputs.target_repo_url }}\`\n* **å¼€å§‹æ‹‰å–ä»£ç å¹¶æ„å»ºé•œåƒ...**\n\nä½ å¯ä»¥åœ¨ [Actions é¡µé¢](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) æŸ¥çœ‹å®æ—¶æ—¥å¿—ã€‚`
            });

      - name: ğŸ“¥ 3. æ‹‰å–ç›®æ ‡ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse_comment.outputs.target_repo_name }}
          # ä½¿ç”¨ PAT æ‹‰å–ä»£ç ï¼Œå› ä¸º GITHUB_TOKEN å¯èƒ½æ²¡æœ‰æƒé™è®¿é—®å…¶ä»–ç§æœ‰ä»“åº“
          token: ${{ secrets.CROSS_REPO_PAT }} 
          path: './target-repo' # å°†ä»£ç ä¸‹è½½åˆ°æŒ‡å®šç›®å½•

      - name: ğŸ†” 4. è·å–ä»£ç çš„çŸ­å“ˆå¸Œå€¼ä½œä¸ºé•œåƒæ ‡ç­¾
        id: get_sha
        run: |
          cd ./target-repo
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: ğŸ³ 5. ç™»å½•åˆ° GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # GITHUB_TOKEN æ˜¯ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„ï¼Œç”¨äºè®¤è¯
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ 6. è®¾ç½® Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ› ï¸ 7. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        id: build_and_push
        uses: docker/build-push-action@v5
        with:
          context: ./target-repo  # Dockerfile æ‰€åœ¨çš„ç›®å½•
          push: true
          # é•œåƒå‘½åè§„åˆ™: ghcr.io/ä¸»æ§ä»“åº“æ‰€æœ‰è€…/ç›®æ ‡ä»“åº“å:ä»£ç commitå“ˆå¸Œ
          tags: ghcr.io/${{ github.repository_owner }}/test2:${{ steps.get_sha.outputs.sha }}
          labels: |
            org.opencontainers.image.source=${{ steps.parse_comment.outputs.target_repo_url }}
            org.opencontainers.image.revision=${{ steps.get_sha.outputs.sha }}
      
      # - name: âœ… 8. æˆåŠŸåå›å¤è¯„è®º
      #   if: success()
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: `âœ… æ„å»ºæˆåŠŸï¼\n\n* **é•œåƒåœ°å€:** \`ghcr.io/${{ github.repository_owner }}/${{ steps.parse_comment.outputs.target_repo_name##*/ }}:${{ steps.get_sha.outputs.sha }}\`\n\nä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‹‰å–é•œåƒï¼š\n\`\`\`bash\ndocker pull ghcr.io/${{ github.repository_owner }}/${{ steps.parse_comment.outputs.target_repo_name##*/ }}:${{ steps.get_sha.outputs.sha }}\n\`\`\``
      #       });

      - name: âŒ 9. å¤±è´¥åå›å¤è¯„è®º
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ æ„å»ºå¤±è´¥ã€‚\n\nè¯·æ£€æŸ¥ [Actions æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`
            });